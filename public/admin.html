<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - CryptoWave</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0f;
      color: #ffffff;
      min-height: 100vh;
    }

    .admin-container { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, #121218 0%, #0f0f14 100%);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      position: fixed;
      height: 100vh;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.25rem;
    }

    .sidebar-logo span { font-size: 1.125rem; font-weight: 800; }
    .sidebar-logo small { display: block; font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); font-weight: 400; }

    .sidebar-nav { flex: 1; padding: 1rem; overflow-y: auto; }
    .nav-section { margin-bottom: 1.5rem; }
    .nav-section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255, 255, 255, 0.4); padding: 0.5rem 1rem; }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      border-radius: 10px;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: #ffffff; }
    .nav-item.active {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
      color: #ffffff;
      border-left: 3px solid #667eea;
    }

    .nav-item .icon { font-size: 1.125rem; }
    .nav-item .badge { margin-left: auto; background: #ef4444; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 10px; font-weight: 700; }

    .sidebar-footer { padding: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }

    .logout-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      width: 100%;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      color: #ef4444;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .logout-btn:hover { background: rgba(239, 68, 68, 0.2); }

    /* Main Content */
    .main-content { flex: 1; margin-left: 260px; min-height: 100vh; }

    .header {
      padding: 1.5rem 2rem;
      background: rgba(18, 18, 24, 0.8);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .header h1 { font-size: 1.5rem; font-weight: 700; }

    .refresh-btn {
      padding: 0.625rem 1rem;
      background: rgba(102, 126, 234, 0.2);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 8px;
      color: #667eea;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .refresh-btn:hover { background: rgba(102, 126, 234, 0.3); }

    .content { padding: 2rem; }
    .page-section { display: none; }
    .page-section.active { display: block; }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(18, 18, 24, 0.95) 0%, rgba(15, 15, 20, 0.95) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.2s ease;
    }

    .stat-card:hover { border-color: rgba(102, 126, 234, 0.5); transform: translateY(-2px); }
    .stat-card .icon { font-size: 2rem; margin-bottom: 1rem; }
    .stat-card .label { font-size: 0.875rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 0.5rem; }
    .stat-card .value { font-size: 1.75rem; font-weight: 800; }
    .stat-card .change { font-size: 0.8rem; color: #10b981; margin-top: 0.5rem; }

    .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; }

    /* Tables */
    .table-container {
      background: rgba(18, 18, 24, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .table { width: 100%; border-collapse: collapse; }
    .table th {
      background: rgba(255, 255, 255, 0.03);
      padding: 1rem 1.25rem;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.7);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .table td { padding: 1rem 1.25rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 0.9rem; }
    .table tr:hover { background: rgba(255, 255, 255, 0.02); }
    .table tr:last-child td { border-bottom: none; }

    /* Badges */
    .badge { display: inline-block; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .badge-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .badge-warning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .badge-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .badge-info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .badge-vip { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%); color: #fbbf24; }

    /* Buttons */
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    .btn-success { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
    .btn-success:hover { background: rgba(16, 185, 129, 0.3); }
    .btn-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.3); }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
    .action-btns { display: flex; gap: 0.5rem; }

    /* Cards & Forms */
    .card { background: rgba(18, 18, 24, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .card-title { font-size: 1rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; font-size: 0.875rem; font-weight: 600; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.5rem; }
    .form-input { width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; color: #ffffff; font-size: 0.9rem; transition: all 0.2s ease; }
    .form-input:focus { outline: none; border-color: #667eea; background: rgba(255, 255, 255, 0.08); }
    .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.show { display: flex; }
    .modal { background: #121218; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 1.125rem; font-weight: 700; }
    .modal-close { background: none; border: none; color: rgba(255, 255, 255, 0.5); font-size: 1.5rem; cursor: pointer; }
    .modal-close:hover { color: #ffffff; }
    .modal-body { padding: 1.5rem; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: flex-end; gap: 0.75rem; }

    /* Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
    .toast { background: rgba(18, 18, 24, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem; min-width: 300px; animation: slideIn 0.3s ease; }
    .toast.success { border-color: rgba(16, 185, 129, 0.3); }
    .toast.error { border-color: rgba(239, 68, 68, 0.3); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .empty-state { text-align: center; padding: 3rem 2rem; color: rgba(255, 255, 255, 0.5); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 3rem; }
    .spinner { width: 40px; height: 40px; border: 3px solid rgba(255, 255, 255, 0.1); border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .wallet-address { font-family: 'Monaco', 'Courier New', monospace; font-size: 0.85rem; }
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .toggle-switch { position: relative; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.1); border-radius: 26px; transition: 0.3s; }
    .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    input:checked + .toggle-slider { background: #667eea; }
    input:checked + .toggle-slider:before { transform: translateX(24px); }

    /* Mobile Menu Button */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1001;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      width: 44px;
      height: 44px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .mobile-menu-btn span {
      width: 20px;
      height: 2px;
      background: #ffffff;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    .mobile-menu-btn.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    .mobile-menu-btn.active span:nth-child(2) {
      opacity: 0;
    }
    .mobile-menu-btn.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99;
      backdrop-filter: blur(4px);
    }

    .mobile-overlay.show {
      display: block;
    }

    @media (max-width: 1024px) {
      .mobile-menu-btn { display: flex; }
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; }
      .header { padding-left: 4.5rem; }
      .form-row { grid-template-columns: 1fr; }
      .content { padding: 1.5rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
        padding-left: 4rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }
      .header h1 { font-size: 1.25rem; }
      .content { padding: 1rem; }
      .stats-grid { grid-template-columns: 1fr; }
      .stat-card { padding: 1rem; }
      .stat-card .value { font-size: 1.5rem; }

      /* Responsive table */
      .table-container { overflow-x: auto; }
      .table { min-width: 600px; }
      .table th, .table td { padding: 0.75rem; font-size: 0.8rem; }
      .action-btns { flex-direction: column; gap: 0.25rem; }
      .action-btns .btn { width: 100%; text-align: center; }

      .settings-grid { grid-template-columns: 1fr; }
      .modal { margin: 1rem; max-width: calc(100% - 2rem); }
      .toast { min-width: auto; max-width: calc(100vw - 40px); }
    }

    @media (max-width: 480px) {
      .mobile-menu-btn {
        top: 0.75rem;
        left: 0.75rem;
        width: 40px;
        height: 40px;
      }
      .header { padding-left: 3.5rem; }
      .section-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }
      .section-title .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Mobile Overlay -->
  <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="logo-icon">C</div>
          <div>
            <span>CryptoWave</span>
            <small>Admin Panel</small>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Main</div>
          <button class="nav-item active" data-page="dashboard">
            <span class="icon">üìä</span>
            <span>Dashboard</span>
          </button>
          <button class="nav-item" data-page="users">
            <span class="icon">üë•</span>
            <span>Users</span>
          </button>
          <button class="nav-item" data-page="approvals">
            <span class="icon">‚úÖ</span>
            <span>Approvals</span>
            <span class="badge" id="pending-count">0</span>
          </button>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Finance</div>
          <button class="nav-item" data-page="platform-wallets">
            <span class="icon">üè¶</span>
            <span>Platform Wallets</span>
          </button>
          <button class="nav-item" data-page="transactions">
            <span class="icon">üí≥</span>
            <span>Transactions</span>
          </button>
          <button class="nav-item" data-page="withdrawals">
            <span class="icon">üí∏</span>
            <span>Withdrawals</span>
            <span class="badge" id="withdrawal-count" style="display:none;">0</span>
          </button>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">System</div>
          <button class="nav-item" data-page="settings">
            <span class="icon">‚öôÔ∏è</span>
            <span>Settings</span>
          </button>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">
          <span>üö™</span>
          <span>Logout</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="header">
        <h1 id="page-title">Dashboard</h1>
        <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
      </header>

      <div class="content">
        <!-- Dashboard Page -->
        <section id="page-dashboard" class="page-section active">
          <div class="stats-grid" id="stats-grid"><div class="loading"><div class="spinner"></div></div></div>
          <div class="section-title">Recent Activity</div>
          <div class="table-container">
            <table class="table">
              <thead><tr><th>User</th><th>Action</th><th>Amount</th><th>Date</th><th>Status</th></tr></thead>
              <tbody id="recent-activity"><tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- Users Page -->
        <section id="page-users" class="page-section">
          <div class="section-title">All Users <button class="btn btn-primary btn-sm" style="margin-left: 1rem;" onclick="refreshWalletBalances()">üîÑ Refresh Balances</button></div>
          <div class="table-container">
            <table class="table">
              <thead><tr><th>ID</th><th>Wallet Address</th><th>Wallet Balance</th><th>Staked</th><th>Earned</th><th>VIP</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="users-table"><tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- Approvals Page -->
        <section id="page-approvals" class="page-section">
          <div class="section-title">Pending Wallet Approvals</div>
          <div class="table-container">
            <table class="table">
              <thead><tr><th>Wallet Address</th><th>Wallet Balance</th><th>IP Address</th><th>Request Time</th><th>Actions</th></tr></thead>
              <tbody id="approvals-table"><tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- Transactions Page -->
        <section id="page-transactions" class="page-section">
          <div class="section-title">All Transactions</div>
          <div class="table-container">
            <table class="table">
              <thead><tr><th>ID</th><th>Wallet</th><th>Type</th><th>Amount</th><th>Date</th><th>Status</th></tr></thead>
              <tbody id="transactions-table"><tr><td colspan="6" class="loading"><div class="spinner"></div></td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- Withdrawals Page -->
        <section id="page-withdrawals" class="page-section">
          <div class="section-title">Pending Withdrawals</div>
          <div class="table-container">
            <table class="table">
              <thead><tr><th>ID</th><th>Wallet Address</th><th>Amount</th><th>Fee</th><th>Net Amount</th><th>Requested</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="withdrawals-table"><tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr></tbody>
            </table>
          </div>
          <div class="section-title" style="margin-top: 2rem;">All Withdrawals</div>
          <div class="table-container">
            <table class="table">
              <thead><tr><th>ID</th><th>Wallet Address</th><th>Amount</th><th>Fee</th><th>Net Amount</th><th>Requested</th><th>Status</th></tr></thead>
              <tbody id="all-withdrawals-table"><tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- Platform Wallets Page -->
        <section id="page-platform-wallets" class="page-section">
          <div class="section-title">Platform Wallets</div>
          <p style="color: #94a3b8; margin-bottom: 24px;">Configure the wallets used by the platform. The <strong>Platform Wallet</strong> is where user stakes are stored. The <strong>Commission Wallet</strong> is where withdrawal fees and commissions are sent.</p>
          <div class="settings-grid">
            <div class="card">
              <div class="card-title">üè¶ Platform Wallet (Stake Storage)</div>
              <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">This is the main wallet where all user staked funds are held. When users stake USDT, it goes to this address.</p>
              <div class="form-group">
                <label>Wallet Address</label>
                <input type="text" class="form-input" id="setting-platformWallet" placeholder="0x..." style="font-family: monospace;">
              </div>
              <div id="platform-wallet-status" style="margin-top: 8px;"></div>
            </div>
            <div class="card">
              <div class="card-title">üí∞ Commission Wallet (Fee Collection)</div>
              <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">Withdrawal fees and platform commissions are sent to this address. This can be the same as or different from the platform wallet.</p>
              <div class="form-group">
                <label>Wallet Address</label>
                <input type="text" class="form-input" id="setting-commissionWallet" placeholder="0x..." style="font-family: monospace;">
              </div>
              <div id="commission-wallet-status" style="margin-top: 8px;"></div>
            </div>
          </div>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-primary" onclick="savePlatformWallets()">Save Wallets</button>
            <button class="btn" onclick="loadPlatformWallets()" style="background: #1e293b; color: #e2e8f0; border: 1px solid #334155;">Refresh</button>
          </div>
        </section>

        <!-- Settings Page -->
        <section id="page-settings" class="page-section">
          <div class="section-title">Platform Settings</div>
          <div class="settings-grid">
            <div class="card">
              <div class="card-title">üí∞ APY Settings</div>
              <div class="form-group"><label>Base APY (%)</label><input type="number" class="form-input" id="setting-baseAPY" step="0.1"></div>
              <div class="form-group"><label>VIP 1 Bonus (%)</label><input type="number" class="form-input" id="setting-vip1Bonus" step="0.1"></div>
              <div class="form-group"><label>VIP 2 Bonus (%)</label><input type="number" class="form-input" id="setting-vip2Bonus" step="0.1"></div>
              <div class="form-group"><label>VIP 3 Bonus (%)</label><input type="number" class="form-input" id="setting-vip3Bonus" step="0.1"></div>
            </div>
            <div class="card">
              <div class="card-title">üìä Limits & Fees</div>
              <div class="form-group"><label>Minimum Stake (USDT)</label><input type="number" class="form-input" id="setting-minStake"></div>
              <div class="form-group"><label>Maximum Stake (USDT)</label><input type="number" class="form-input" id="setting-maxStake"></div>
              <div class="form-group"><label>Withdrawal Fee (%)</label><input type="number" class="form-input" id="setting-withdrawalFee" step="0.1"></div>
              <div class="form-group"><label>Maintenance Mode</label><label class="toggle-switch"><input type="checkbox" id="setting-maintenanceMode"><span class="toggle-slider"></span></label></div>
            </div>
          </div>
          <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        </section>
      </div>
    </main>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" id="edit-user-modal">
    <div class="modal">
      <div class="modal-header"><h3>Edit User</h3><button class="modal-close" onclick="closeModal('edit-user-modal')">&times;</button></div>
      <div class="modal-body">
        <input type="hidden" id="edit-user-id">
        <div class="form-group"><label>Wallet Address</label><input type="text" class="form-input" id="edit-wallet" readonly></div>
        <div class="form-row">
          <div class="form-group"><label>Staked Amount (USDT)</label><input type="number" class="form-input" id="edit-staked"></div>
          <div class="form-group"><label>Total Earned (USDT)</label><input type="number" class="form-input" id="edit-earned"></div>
        </div>
        <div class="form-group"><label>Status</label><select class="form-input" id="edit-status"><option value="active">Active</option><option value="pending">Pending</option><option value="banned">Banned</option></select></div>
      </div>
      <div class="modal-footer"><button class="btn btn-danger" onclick="closeModal('edit-user-modal')">Cancel</button><button class="btn btn-primary" onclick="saveUserEdit()">Save Changes</button></div>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <script>
    const API_URL = window.location.origin;
    let token = localStorage.getItem('adminToken');

    if (!token) window.location.href = '/admin/login';
    verifyAuth();

    async function verifyAuth() {
      try {
        const response = await fetch(`${API_URL}/api/admin/verify`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!response.ok) throw new Error('Unauthorized');
        loadDashboard();
      } catch (error) {
        localStorage.removeItem('adminToken');
        window.location.href = '/admin/login';
      }
    }

    async function api(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_URL}${endpoint}`, {
          ...options,
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers }
        });
        if (response.status === 401) {
          localStorage.removeItem('adminToken');
          window.location.href = '/admin/login';
          return null;
        }
        if (!response.ok) {
          console.error('API error:', response.status, response.statusText);
          return null;
        }
        return response.json();
      } catch (error) {
        console.error('API fetch error:', error);
        throw error;
      }
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const page = item.dataset.page;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
        document.getElementById(`page-${page}`).classList.add('active');
        document.getElementById('page-title').textContent = item.querySelector('span:last-of-type').textContent;
        loadPageData(page);
      });
    });

    function loadPageData(page) {
      switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'users': loadUsers(); break;
        case 'approvals': loadApprovals(); break;
        case 'transactions': loadTransactions(); break;
        case 'withdrawals': loadWithdrawals(); break;
        case 'platform-wallets': loadPlatformWallets(); break;
        case 'settings': loadSettings(); break;
      }
    }

    async function loadDashboard() {
      try {
        const stats = await api('/api/admin/stats');
        const transactions = await api('/api/admin/transactions');
        const pendingWithdrawals = await api('/api/admin/withdrawals/pending');
        const pendingWithdrawalCount = pendingWithdrawals ? pendingWithdrawals.length : 0;

        document.getElementById('stats-grid').innerHTML = `
          <div class="stat-card"><div class="icon">üë•</div><div class="label">Total Users</div><div class="value">${stats.totalUsers}</div><div class="change">${stats.activeUsers} active</div></div>
          <div class="stat-card"><div class="icon">üíé</div><div class="label">Total Staked</div><div class="value">$${stats.totalStaked.toLocaleString()}</div><div class="change">USDT</div></div>
          <div class="stat-card"><div class="icon">üìà</div><div class="label">Total Earnings</div><div class="value">$${stats.totalEarnings.toLocaleString()}</div><div class="change">Distributed</div></div>
          <div class="stat-card"><div class="icon">‚è≥</div><div class="label">Pending Approvals</div><div class="value">${stats.pendingApprovals}</div><div class="change">Awaiting review</div></div>
          <div class="stat-card"><div class="icon">üí∏</div><div class="label">Pending Withdrawals</div><div class="value">${pendingWithdrawalCount}</div><div class="change">Awaiting approval</div></div>
        `;
        document.getElementById('pending-count').textContent = stats.pendingApprovals;

        // Update withdrawal badge
        const wCountEl = document.getElementById('withdrawal-count');
        if (pendingWithdrawalCount > 0) {
          wCountEl.textContent = pendingWithdrawalCount;
          wCountEl.style.display = 'inline-block';
        } else {
          wCountEl.style.display = 'none';
        }
        document.getElementById('recent-activity').innerHTML = transactions.slice(0, 5).map(tx => `
          <tr><td class="wallet-address">${tx.walletAddress}</td><td><span class="badge badge-info">${tx.type}</span></td><td>$${tx.amount.toLocaleString()}</td><td>${tx.date}</td><td><span class="badge badge-${tx.status === 'completed' ? 'success' : 'warning'}">${tx.status}</span></td></tr>
        `).join('') || '<tr><td colspan="5" class="empty-state">No recent activity</td></tr>';
      } catch (error) { showToast('Failed to load dashboard', 'error'); }
    }

    let walletBalances = {};

    async function loadUsers() {
      try {
        const users = await api('/api/admin/users');

        if (!users || !Array.isArray(users) || users.length === 0) {
          document.getElementById('users-table').innerHTML = '<tr><td colspan="8" class="empty-state">No users yet. Users appear here after their wallet is approved.</td></tr>';
          return;
        }

        // Show users immediately with 0.00 balance (updates in background)
        document.getElementById('users-table').innerHTML = users.map(user => `
          <tr>
            <td>${user.id}</td>
            <td class="wallet-address">${user.walletAddress.slice(0, 10)}...${user.walletAddress.slice(-8)}</td>
            <td>
              <div style="font-size: 0.85rem;">
                <div><span style="color: #627eea;">‚ü†</span> <span id="user-eth-${user.id}">0.0000 ETH</span></div>
                <div><span style="color: #26A17B;">‚ÇÆ</span> <span id="user-usdt-${user.id}">0.00 USDT</span></div>
              </div>
            </td>
            <td>$${user.stakedAmount.toLocaleString()}</td>
            <td>$${user.totalEarned.toLocaleString()}</td>
            <td><span class="badge badge-vip">VIP ${user.vipLevel}</span></td>
            <td><span class="badge badge-${user.status === 'active' ? 'success' : user.status === 'banned' ? 'danger' : 'warning'}">${user.status}</span></td>
            <td><div class="action-btns"><button class="btn btn-primary btn-sm" onclick="editUser(${user.id})">Edit</button>${user.status === 'active' ? `<button class="btn btn-danger btn-sm" onclick="banUser(${user.id})">Ban</button>` : `<button class="btn btn-success btn-sm" onclick="unbanUser(${user.id})">Unban</button>`}</div></td>
          </tr>
        `).join('');

        // Fetch balances in background (non-blocking)
        fetchUserBalances(users);
      } catch (error) {
        console.error('Load users error:', error);
        showToast('Failed to load users', 'error');
      }
    }

    // Fetch user balances in background
    async function fetchUserBalances(users) {
      for (const user of users) {
        fetchSingleUserBalance(user);
      }
    }

    async function fetchSingleUserBalance(user) {
      const ethEl = document.getElementById(`user-eth-${user.id}`);
      const usdtEl = document.getElementById(`user-usdt-${user.id}`);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const res = await fetch(`${API_URL}/api/wallet-balance/${user.walletAddress}`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        const balance = await res.json();
        if (ethEl) ethEl.textContent = `${balance.eth || '0.0000'} ETH`;
        if (usdtEl) usdtEl.textContent = `${balance.usdt || '0.00'} USDT`;
      } catch (e) {
        // Keep showing 0.00 on error - no change needed
        console.log('Balance fetch timeout for user:', user.id);
      }
    }

    async function refreshWalletBalances() {
      showToast('Refreshing wallet balances...');
      await loadUsers();
      showToast('Wallet balances updated!');
    }

    async function loadApprovals() {
      try {
        console.log('Loading approvals...');
        const pending = await api('/api/admin/pending');
        console.log('Pending wallets:', pending);

        if (!pending || pending.length === 0) {
          document.getElementById('approvals-table').innerHTML = '<tr><td colspan="5" class="empty-state"><div class="icon">‚úÖ</div><p>No pending approvals</p></td></tr>';
          return;
        }

        // Show wallets immediately with 0.00 balance (updates in background)
        document.getElementById('approvals-table').innerHTML = pending.map(wallet => `
          <tr>
            <td class="wallet-address">${wallet.walletAddress}</td>
            <td>
              <div style="font-size: 0.85rem;">
                <div><span style="color: #627eea;">‚ü†</span> <span id="eth-${wallet.walletAddress.slice(-8)}">0.0000 ETH</span></div>
                <div><span style="color: #26A17B;">‚ÇÆ</span> <span id="usdt-${wallet.walletAddress.slice(-8)}">0.00 USDT</span></div>
              </div>
            </td>
            <td>${wallet.ipAddress || 'Unknown'}</td>
            <td>${new Date(wallet.timestamp).toLocaleString()}</td>
            <td><div class="action-btns"><button class="btn btn-success btn-sm" onclick="approveWallet('${wallet.walletAddress}')">‚úÖ Approve</button><button class="btn btn-danger btn-sm" onclick="rejectWallet('${wallet.walletAddress}')">‚ùå Reject</button></div></td>
          </tr>
        `).join('');

        // Fetch balances in background (non-blocking)
        fetchApprovalBalances(pending);
      } catch (error) {
        console.error('Load approvals error:', error);
        showToast('Failed to load approvals', 'error');
        document.getElementById('approvals-table').innerHTML = '<tr><td colspan="5" class="empty-state"><div class="icon">‚ùå</div><p>Failed to load approvals</p></td></tr>';
      }
    }

    // Fetch approval balances in background
    async function fetchApprovalBalances(wallets) {
      for (const wallet of wallets) {
        fetchSingleApprovalBalance(wallet);
      }
    }

    async function fetchSingleApprovalBalance(wallet) {
      const ethEl = document.getElementById(`eth-${wallet.walletAddress.slice(-8)}`);
      const usdtEl = document.getElementById(`usdt-${wallet.walletAddress.slice(-8)}`);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const res = await fetch(`${API_URL}/api/wallet-balance/${wallet.walletAddress}`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        const balance = await res.json();
        if (ethEl) ethEl.textContent = `${balance.eth || '0.0000'} ETH`;
        if (usdtEl) usdtEl.textContent = `${balance.usdt || '0.00'} USDT`;
      } catch (e) {
        // Keep showing 0.00 on error - no change needed
        console.log('Balance fetch timeout for wallet:', wallet.walletAddress.slice(-8));
      }
    }

    async function loadTransactions() {
      try {
        const transactions = await api('/api/admin/transactions');
        document.getElementById('transactions-table').innerHTML = transactions.map(tx => `
          <tr><td>${tx.id}</td><td class="wallet-address">${tx.walletAddress}</td><td><span class="badge badge-info">${tx.type}</span></td><td>$${tx.amount.toLocaleString()}</td><td>${tx.date}</td><td><span class="badge badge-${tx.status === 'completed' ? 'success' : 'warning'}">${tx.status}</span></td></tr>
        `).join('') || '<tr><td colspan="6" class="empty-state">No transactions found</td></tr>';
      } catch (error) { showToast('Failed to load transactions', 'error'); }
    }

    async function loadWithdrawals() {
      try {
        const pending = await api('/api/admin/withdrawals/pending');
        const allWithdrawals = await api('/api/admin/withdrawals');
        const completedWithdrawals = allWithdrawals ? allWithdrawals.filter(w => w.status !== 'pending') : [];

        // Update badge count
        const countEl = document.getElementById('withdrawal-count');
        if (pending && pending.length > 0) {
          countEl.textContent = pending.length;
          countEl.style.display = 'inline-block';
        } else {
          countEl.style.display = 'none';
        }

        // Render pending withdrawals
        if (!pending || pending.length === 0) {
          document.getElementById('withdrawals-table').innerHTML = '<tr><td colspan="8" class="empty-state"><div class="icon">‚úÖ</div><p>No pending withdrawals</p></td></tr>';
        } else {
          document.getElementById('withdrawals-table').innerHTML = pending.map(w => `
            <tr>
              <td>${w.id}</td>
              <td class="wallet-address">${w.walletAddress.slice(0, 10)}...${w.walletAddress.slice(-8)}</td>
              <td>$${w.amount.toLocaleString()}</td>
              <td>$${w.fee.toFixed(2)}</td>
              <td>$${w.netAmount.toFixed(2)}</td>
              <td>${new Date(w.requestedAt).toLocaleString()}</td>
              <td><span class="badge badge-warning">Pending</span></td>
              <td>
                <div class="action-btns">
                  <button class="btn btn-success btn-sm" onclick="approveWithdrawal(${w.id})">‚úÖ Approve</button>
                  <button class="btn btn-danger btn-sm" onclick="rejectWithdrawal(${w.id})">‚ùå Reject</button>
                </div>
              </td>
            </tr>
          `).join('');
        }

        // Render completed/rejected withdrawals
        if (!completedWithdrawals || completedWithdrawals.length === 0) {
          document.getElementById('all-withdrawals-table').innerHTML = '<tr><td colspan="7" class="empty-state">No withdrawal history</td></tr>';
        } else {
          document.getElementById('all-withdrawals-table').innerHTML = completedWithdrawals.map(w => `
            <tr>
              <td>${w.id}</td>
              <td class="wallet-address">${w.walletAddress.slice(0, 10)}...${w.walletAddress.slice(-8)}</td>
              <td>$${w.amount.toLocaleString()}</td>
              <td>$${w.fee.toFixed(2)}</td>
              <td>$${w.netAmount.toFixed(2)}</td>
              <td>${new Date(w.requestedAt).toLocaleString()}</td>
              <td><span class="badge badge-${w.status === 'approved' ? 'success' : 'danger'}">${w.status}</span></td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Load withdrawals error:', error);
        showToast('Failed to load withdrawals', 'error');
      }
    }

    async function approveWithdrawal(id) {
      if (!confirm('Are you sure you want to approve this withdrawal?')) return;
      try {
        await api('/api/admin/withdraw/approve', { method: 'POST', body: JSON.stringify({ withdrawalId: id }) });
        showToast('Withdrawal approved!');
        loadWithdrawals();
        loadDashboard();
      } catch (error) { showToast('Failed to approve withdrawal', 'error'); }
    }

    async function rejectWithdrawal(id) {
      const reason = prompt('Enter rejection reason (optional):');
      if (reason === null) return; // User cancelled
      try {
        await api('/api/admin/withdraw/reject', { method: 'POST', body: JSON.stringify({ withdrawalId: id, reason: reason || 'Rejected by admin' }) });
        showToast('Withdrawal rejected');
        loadWithdrawals();
      } catch (error) { showToast('Failed to reject withdrawal', 'error'); }
    }

    // ==================== PLATFORM WALLETS ====================

    async function loadPlatformWallets() {
      try {
        const settings = await api('/api/admin/settings');
        document.getElementById('setting-platformWallet').value = settings.platformWallet || '';
        document.getElementById('setting-commissionWallet').value = settings.commissionWallet || '';

        // Show status indicators
        const pwStatus = document.getElementById('platform-wallet-status');
        const cwStatus = document.getElementById('commission-wallet-status');

        if (settings.platformWallet) {
          pwStatus.innerHTML = '<span style="color: #22c55e; font-size: 13px;">‚úÖ Configured: ' + settings.platformWallet.slice(0,6) + '...' + settings.platformWallet.slice(-4) + '</span>';
        } else {
          pwStatus.innerHTML = '<span style="color: #f59e0b; font-size: 13px;">‚ö†Ô∏è Not configured yet</span>';
        }

        if (settings.commissionWallet) {
          cwStatus.innerHTML = '<span style="color: #22c55e; font-size: 13px;">‚úÖ Configured: ' + settings.commissionWallet.slice(0,6) + '...' + settings.commissionWallet.slice(-4) + '</span>';
        } else {
          cwStatus.innerHTML = '<span style="color: #f59e0b; font-size: 13px;">‚ö†Ô∏è Not configured yet</span>';
        }
      } catch (error) { showToast('Failed to load platform wallets', 'error'); }
    }

    async function savePlatformWallets() {
      try {
        const platformWallet = document.getElementById('setting-platformWallet').value.trim();
        const commissionWallet = document.getElementById('setting-commissionWallet').value.trim();

        // Basic validation
        if (platformWallet && !platformWallet.startsWith('0x')) {
          showToast('Platform wallet must start with 0x', 'error');
          return;
        }
        if (commissionWallet && !commissionWallet.startsWith('0x')) {
          showToast('Commission wallet must start with 0x', 'error');
          return;
        }

        // Get current settings and merge
        const current = await api('/api/admin/settings');
        await api('/api/admin/settings', {
          method: 'PUT',
          body: JSON.stringify({
            ...current,
            platformWallet,
            commissionWallet
          })
        });
        showToast('Platform wallets saved successfully', 'success');
        loadPlatformWallets();
      } catch (error) { showToast('Failed to save platform wallets', 'error'); }
    }

    // ==================== SETTINGS ====================

    async function loadSettings() {
      try {
        const settings = await api('/api/admin/settings');
        document.getElementById('setting-baseAPY').value = settings.baseAPY;
        document.getElementById('setting-vip1Bonus').value = settings.vip1Bonus;
        document.getElementById('setting-vip2Bonus').value = settings.vip2Bonus;
        document.getElementById('setting-vip3Bonus').value = settings.vip3Bonus;
        document.getElementById('setting-minStake').value = settings.minStake;
        document.getElementById('setting-maxStake').value = settings.maxStake;
        document.getElementById('setting-withdrawalFee').value = settings.withdrawalFee;
        document.getElementById('setting-maintenanceMode').checked = settings.maintenanceMode;
      } catch (error) { showToast('Failed to load settings', 'error'); }
    }

    async function saveSettings() {
      try {
        const settings = {
          baseAPY: parseFloat(document.getElementById('setting-baseAPY').value),
          vip1Bonus: parseFloat(document.getElementById('setting-vip1Bonus').value),
          vip2Bonus: parseFloat(document.getElementById('setting-vip2Bonus').value),
          vip3Bonus: parseFloat(document.getElementById('setting-vip3Bonus').value),
          minStake: parseFloat(document.getElementById('setting-minStake').value),
          maxStake: parseFloat(document.getElementById('setting-maxStake').value),
          withdrawalFee: parseFloat(document.getElementById('setting-withdrawalFee').value),
          maintenanceMode: document.getElementById('setting-maintenanceMode').checked
        };
        await api('/api/admin/settings', { method: 'PUT', body: JSON.stringify(settings) });
        showToast('Settings saved successfully!');
      } catch (error) { showToast('Failed to save settings', 'error'); }
    }

    async function approveWallet(address) {
      try {
        await api('/api/admin/approve', { method: 'POST', body: JSON.stringify({ walletAddress: address }) });
        showToast('Wallet approved!');
        loadApprovals();
        loadDashboard();
      } catch (error) { showToast('Failed to approve wallet', 'error'); }
    }

    async function rejectWallet(address) {
      if (!confirm('Are you sure you want to reject this wallet?')) return;
      try {
        await api('/api/admin/reject', { method: 'POST', body: JSON.stringify({ walletAddress: address }) });
        showToast('Wallet rejected');
        loadApprovals();
      } catch (error) { showToast('Failed to reject wallet', 'error'); }
    }

    async function editUser(id) {
      try {
        const user = await api(`/api/admin/users/${id}`);
        document.getElementById('edit-user-id').value = user.id;
        document.getElementById('edit-wallet').value = user.walletAddress;
        document.getElementById('edit-staked').value = user.stakedAmount;
        document.getElementById('edit-earned').value = user.totalEarned;
        document.getElementById('edit-status').value = user.status;
        document.getElementById('edit-user-modal').classList.add('show');
      } catch (error) { showToast('Failed to load user', 'error'); }
    }

    async function saveUserEdit() {
      const id = document.getElementById('edit-user-id').value;
      try {
        await api(`/api/admin/users/${id}/balance`, { method: 'POST', body: JSON.stringify({ stakedAmount: parseFloat(document.getElementById('edit-staked').value), totalEarned: parseFloat(document.getElementById('edit-earned').value) }) });
        await api(`/api/admin/users/${id}/status`, { method: 'POST', body: JSON.stringify({ status: document.getElementById('edit-status').value }) });
        closeModal('edit-user-modal');
        showToast('User updated successfully!');
        loadUsers();
      } catch (error) { showToast('Failed to update user', 'error'); }
    }

    async function banUser(id) {
      if (!confirm('Are you sure you want to ban this user?')) return;
      try {
        await api(`/api/admin/users/${id}/status`, { method: 'POST', body: JSON.stringify({ status: 'banned' }) });
        showToast('User banned');
        loadUsers();
      } catch (error) { showToast('Failed to ban user', 'error'); }
    }

    async function unbanUser(id) {
      try {
        await api(`/api/admin/users/${id}/status`, { method: 'POST', body: JSON.stringify({ status: 'active' }) });
        showToast('User unbanned');
        loadUsers();
      } catch (error) { showToast('Failed to unban user', 'error'); }
    }

    function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    function refreshData() { const activePage = document.querySelector('.nav-item.active').dataset.page; loadPageData(activePage); showToast('Data refreshed!'); }
    function logout() { localStorage.removeItem('adminToken'); window.location.href = '/admin/login'; }

    // Mobile menu functions
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobile-overlay');
      const btn = document.getElementById('mobile-menu-btn');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('show');
      btn.classList.toggle('active');
    }

    function closeMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobile-overlay');
      const btn = document.getElementById('mobile-menu-btn');
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
      btn.classList.remove('active');
    }

    // Close mobile menu when nav item is clicked
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        if (window.innerWidth <= 1024) {
          closeMobileMenu();
        }
      });
    });

    setInterval(() => { const activePage = document.querySelector('.nav-item.active').dataset.page; loadPageData(activePage); }, 30000);
  </script>
</body>
</html>
